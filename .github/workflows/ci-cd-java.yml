name: Java CI + Postman Functional Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-unit:
    runs-on: ubuntu-latest
    services:
      # optional: start a real DB service for integration tests
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: testdb
        ports: ['5432:5432']
        options: >-
          --health-cmd="pg_isready -U test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Build & run unit tests
        run: mvn -B -DskipITs=true clean verify

      - name: Package artifact (skip tests)
        run: mvn -B package -DskipTests

      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/*.jar

  functional-tests:
    needs: build-and-unit
    runs-on: ubuntu-latest
    env:
      APP_PORT: 8080
      BASE_URL: http://localhost:8080
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: ./artifact

      - name: Set up JDK 21 (runner)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Start backend (background)
        run: |
          nohup java -jar ./artifact/*.jar --spring.profiles.active=test > app.log 2>&1 &
          echo "Waiting for /actuator/health"
          for i in {1..30}; do
            if curl -sSf http://localhost:8080/actuator/health >/dev/null 2>&1; then
              echo "App is up"
              break
            fi
            echo "waiting..."
            sleep 2
          done
          tail -n +1 app.log || true

      - name: Setup Node (for newman)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install newman
        run: npm install -g newman@5

      - name: Run Postman collection (Newman)
        run: |
          if [ -f "postman/collection.json" ]; then
            newman run postman/collection.json -e postman/env.json --reporters cli,junit --reporter-junit-export newman-report.xml || true
          else
            echo "Postman collection not found, skipping Newman run"
          fi

      - name: Check for Newman report
        id: check-report
        run: |
          if [ -f "newman-report.xml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload app log
        uses: actions/upload-artifact@v4
        with:
          name: app-log
          path: app.log

      - name: Upload Newman report
        if: steps.check-report.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: newman-report
          path: newman-report.xml

  deploy:
    needs: functional-tests
    if: github.ref == 'refs/heads/main' && needs.functional-tests.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Heroku (example)
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_APP_NAME: ${{ secrets.HEROKU_APP_NAME }}
        run: |
          # Using Heroku jar deploy (via container or API). Example simple release via Heroku CLI (needs container or buildpack)
          echo "Deploy steps go here â€” choose your target (Heroku, EKS, EB, GCP)."
